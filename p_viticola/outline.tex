% \documentclass[english, draft]{article}
\documentclass[english]{article}

%\usepackage[showframe]{geometry}
\usepackage{geometry}
\usepackage{float}
\usepackage[utf8]{inputenc}
\usepackage[backend=biber,style= authoryear]{biblatex}
\usepackage[english]{babel}
\usepackage{csquotes}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{booktabs}

\usepackage{xargs}
\usepackage[pdftex,dvipsnames,table]{xcolor}

\graphicspath{{./resources/images}}
\addbibresource{../articles.bib}
\addbibresource{../manual.bib}

\geometry{a4paper, total={165mm,257mm}, left=15mm, top=20mm,}

\def\changemargin#1#2{\list{}{\rightmargin#2\leftmargin#1}\item[]}
\let\endchangemargin=\endlist

\title{ Outline for \textit{downy Mildew} article}
\date{22nd July 2023}
\author{}

\begin{document}
\pagenumbering{arabic}
\maketitle

\begin{changemargin}{60pt}{60pt}
	\begin{abstract}
		\textbf{Goal(s):}
		\begin{itemize}
                \item Computer science
                \begin{itemize}
    			\item Create method to use automatically phenotype the interaction between PV and Vitis
                    \item high throughput phenotyping
    			\item Validate the method by finding QTL in  experiments
    			\item Compare human vs machine annotation
                \end{itemize}
                \item Biology
                \begin{itemize}
                    \item plant breeding for mildew resistance
                    \item need to identify resistance genes in species related to the Vitis genus and in study populations
                \end{itemize}
		\end{itemize}

		\textbf{Research or Methodology:}
		\begin{itemize}
			\item Methodology
		\end{itemize}

		\textbf{Too many images}
  
	\end{abstract}
\end{changemargin}

\tableofcontents

\section{Background}

\subsection{Vitis}

\begin{figure}[H]
	\begin{center}
		\includegraphics[width=0.7\linewidth]{2023_cdt_oiv_world.png}
		\caption{OIV nations}\label{fig:oivworld}
	\end{center}
\end{figure}

\subsection{downy Mildew}

\begin{itemize}
	\item Description/taxonomy \textbf{velazquez} 
	\item Infection mode and organ targets
	\item History~\parencite*{fontaineEuropeBridgeheadWorldwide2021} \textbf{?}
	\item Consequences
	      \begin{itemize}
		      \item Yield loss
		      \item Increased use of fongicides 80\% of usage for 20\% of area (\textbf{needs citation}) ->
		            \begin{itemize}
			            \item Increased costs
			            \item Ecological impact
			            \item Health impact
		            \end{itemize}
	      \end{itemize}
\end{itemize}

\subsection{Existing}

\begin{enumerate}
	\item European grapevines are sensitive to American pathogens~\parencite*{fontaineEuropeBridgeheadWorldwide2021}
	\item Classical breeders -> poor quality wine
	\item Quality breeders after the 50s \textbf{needs citation} \textbf{?}
	\item Introduce OIV and OIV 452-1
        \begin{itemize}
            \item OIV = Office Int...
            \item OIV has full ontology
            \item OIV 452-1 resistance to DM in leaf disks
        \end{itemize}
	\item Critique scale \parencite{possamaiPhenotypingQTLIdentification2022}
        \begin{itemize}
            \item takes into account spor and necr -> needs training
            \item plus allows comparison
            \item nevertheless \parencite{possamaiPhenotypingQTLIdentification2022}
        \end{itemize}
	\item Rpv3.1, Rpv10- and Rpv12 ... \textbf{needs citation} \textbf{Which ones were found with manual annotations}
        \begin{itemize}
            \item  \parencite{possamaiPhenotypingQTLIdentification2022} list of QTLs and how they were found
        \end{itemize}
	\item Image processing tools \parencite{hernandezAssessmentDownyMildew2022}, \parencite{zendlerHighthroughputPhenotypingLeaf2021}
\end{enumerate}

\subsection{Novelty}

\begin{itemize}
	\item Current computer vision approaches only look at sporulation
	\item Our approach looks at sporulation plus 3 types of necrosis \textbf{necrosis as important as sporulation?}
	\item \textbf{TODO} \textbf{Goal}: Predict OIV 452-1 from images for binary variables
	\item \textbf{TODO} Test on existing experiments
\end{itemize}

\section{Materials and Methods}

\subsection{Plants}

\parencite{bellinResistancePlasmoparaViticola2009} \textbf{new version needed}

\subsection{Infection}

\parencite{bellinResistancePlasmoparaViticola2009}

\subsection{Image acquisition}

\begin{itemize}
	\item Acquisitions since 2018
	\item Multiple acquisition Methods != camera, lenses, lightning, framing, compression, post processing -> needs additional work to exploit the data \textbf{Why not use simple approach?}
	\item Plates
\end{itemize}

\subsection{Existing data overview}

\begin{figure}
	\begin{center}
		\includegraphics[width=0.7\linewidth]{oiv_452-1_desc.png}
		\caption{Additional variables}\label{fig:newvariables} \textbf{To be replaced by text}
	\end{center}
\end{figure}

\begin{itemize}
	\item Database structure: Excels + images in folders with experiment metadata
	\item OIV and additional variables
	      \begin{itemize}
		      \item OIV 452-1
		      \item New variables~\ref*{fig:newvariables}
	      \end{itemize}
	\item -> Excel to CSV
	\item Naive prediction
	      \begin{itemize}
		      \item LDA, random forrest
		      \item fail~\ref{fig:predictionfail} means that additional variables are not able to predict OIV, but they still may have signal
		      \item multiple OIV values per combination~\ref*{tab:oivconfusion}
	      \end{itemize}
\end{itemize}

\begin{figure}[H]
	\begin{center}
		\includegraphics[width=0.7\linewidth,trim={1mm 0 0 0},clip]{annotations_da_rfc_cm.png}
		\caption{Prediction fail}\label{fig:predictionfail}
	\end{center}
\end{figure}
Fig: \ref{fig:predictionfail}

\begin{table}[H]
	\centering
	\caption{OIV row multi-value}\label{tab:oivconfusion}
	\begin{tabular}{rrrrrccccc}
		\toprule
		sporulation & sporulation & necrosis & necrosis & necrosis & oiv 1 & oiv 3 & oiv 5 & oiv 7 & oiv 9 \\
		{}          & density     & {}       & size     & area     & {}    & {}    & {}    & {}    & {}    \\
		\midrule
		1           & 1           & 0        & 1        & 1        & X     & X     & X     & X     &       \\
		1           & 7           & 1        & 3        & 5        & X     & X     & X     & X     &       \\
		1           & 5           & 1        & 9        & 9        & X     & X     & X     & X     &       \\
		1           & 5           & 1        & 1        & 7        &       &       & X     & X     &       \\
		1           & 1           & 1        & 3        & 1        &       &       & X     & X     &       \\
		0           & 1           & 1        & 3        & 3        &       &       &       & X \textbf{ERROR}     & X     \\
		\bottomrule
	\end{tabular}
\end{table}

\subsection{Leaf Extraction}

\begin{figure}
	\centering
	\includegraphics[width=0.8\linewidth]{plate_index_v2_fixed.png}
	\caption*{Leaf disc detect }
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.8\linewidth]{ld_detector_brute_force.png}
	\caption{Patch extraction}\label{fig:patchextraction}
\end{figure}

\textbf{Add image more representative of various steps needed to index and the difficulties faced}

\begin{itemize}
	\item Ilastik~\parencite{bergIlastikInteractiveMachine2019} fail because extremely different images
	\item U-Net~\parencite{ronnebergerUNetConvolutionalNetworks2015} misses some leaf discs in corner cases
	\item Fast R-CNN~\parencite{girshickFastRCNN2015}
	\item Indexation
	\item Patch extraction~\ref{fig:patchextraction}
\end{itemize}

\textbf{Talk about failed approaches?}

\subsection{Binary prediction}
Zooniverse \parencite{zooniverse}

\textbf{Add set construction to methodo}

\begin{itemize}
	\item online annotation platform
	\item Multiple annotations per disc
\end{itemize}

\subsubsection{Image Annotation}

\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{0.2\linewidth}
		\includegraphics[width=\linewidth]{Exp21DM01_inoc1_T6_P24_c_2.png}
		\caption{Sporulation}\label{fig:sporulation}
	\end{subfigure}
	\begin{subfigure}[b]{0.2\linewidth}
		\includegraphics[width=\linewidth]{Exp20DM01_inoc1_T6_P17_c_1.png}
		\caption{Necrosis spots}\label{fig:necrosisspots}
	\end{subfigure}
	\begin{subfigure}[b]{0.2\linewidth}
		\includegraphics[width=\linewidth]{Exp20DM01_inoc2_T6_P47_c_4.png}
		\caption{Necrosis flecks}\label{fig:necrosisstains}
	\end{subfigure}
	\begin{subfigure}[b]{0.2\linewidth}
		\includegraphics[width=\linewidth]{Exp21DM01_inoc1_T6_P27_b_2.png}
		\caption{Necrosis senescence}\label{fig:necrosissenescence}
	\end{subfigure}
	\caption{The Four Phenotypes}\label{fig:phenotypes}
\end{figure}

Four phenotypes~\ref*{fig:phenotypes}

\begin{table}[H]
	\caption{Zooniverse V1 data}\label{tab:zv1data}
	\begin{minipage}{0.4\linewidth}
		% \centering
		\caption{Class cardinals}\label{tab:zoonv1classcardinals}
		\begin{tabular}{rc}
			\toprule
			Phenotype           & Count \\
			\midrule
			sporulation         & 757   \\
			necrosis spots       & 247   \\
			necrosis flecks     & 149   \\
			necrosis senescence & 50    \\
			\bottomrule
		\end{tabular}
	\end{minipage}%
	\begin{minipage}{0.4\linewidth}
		\centering
		\caption{Classification report}\label{tab:zv1mcr}
		\begin{tabular}{rcccc}
			\toprule
			{}                                    & Precision & Recall & F1 score & Support \\
			\midrule
			sporulation                           & 0.92      & 0.93   & 0.93     & 113     \\
			necrosis spots                         & 0.82      & 0.38   & 0.52     & 37      \\
			\rowcolor{red!25} necrosis flecks     & 0.00      & 0.00   & 0.00     & 22      \\
			\rowcolor{red!25} necrosis senescence & 0.00      & 0.00   & 0.00     & 8       \\
			micro avg                             & 0.91      & 0.66   & 0.77     & 180     \\
			macro avg                             & 0.44      & 0.33   & 0.36     & 180     \\
			weighted avg                          & 0.75      & 0.66   & 0.69     & 180     \\
			\bottomrule
		\end{tabular}
	\end{minipage}
\end{table}

\begin{table}[H]
	\caption{Zooniverse V2 data}\label{tab:zv2data}
	\begin{minipage}{0.4\linewidth}
		\centering
		\caption{Class cardinals}\label{tab:zoonv2classcardinals}
		\begin{tabular}{rc}
			\toprule
			Phenotype           & Count \\
			\midrule
			sporulation         & 1188  \\
			necrosis spots       & 578   \\
			necrosis flecks     & 467   \\
			necrosis senescence & 271   \\
			\bottomrule
		\end{tabular}
	\end{minipage}%
	\begin{minipage}{0.4\linewidth}
		\centering
		\caption{Classification report}\label{tab:zv2mcr}
		\begin{tabular}{rcccc}
			\toprule
			{}                   & precision & recall & f1-score & support \\
			\midrule
			sporulation          & 0.9922    & 0.9078 & 0.9481   & 141     \\
			necrosis\_spots       & 0.9388    & 0.8679 & 0.9020   & 106     \\
			necrosis\_stains     & 0.7313    & 0.7656 & 0.7481   & 64      \\
			necrosis\_senescence & 0.6800    & 0.8947 & 0.7727   & 38      \\
			micro avg            & 0.8808    & 0.8682 & 0.8745   & 349     \\
			macro avg            & 0.8356    & 0.8590 & 0.8427   & 349     \\
			weighted avg         & 0.8942    & 0.8682 & 0.8783   & 349     \\
			\bottomrule
		\end{tabular}
	\end{minipage}
\end{table}

\textbf{Annotation rounds used to show human error} -- \textbf{?}
\textbf{Are all annotation rounds and models needed? Or only discuss shortcommings}

\begin{itemize}
	\item round 1
	      \begin{itemize}
		      \item class cardinal problems~\ref*{tab:zv1data}
		      \item Image quality
	      \end{itemize}
	\item round 2 and 2+
	      \begin{itemize}
		      \item annotation conflict problems~\ref*{tab:zv2data}
		      \item Expert cleanup
	      \end{itemize}
	\item round 3 -> experts only. Annotation by agreement
\end{itemize}

\subsubsection{Model}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{2023_cdt_data_frac_evolution.png}
	\caption*{Ablation tests}\label{fig:ablationtests}
\end{figure}

\begin{itemize}
    \item pytorch + pytorch lightning
    \item based on~\ref{dosovitskiyImageWorth16x162021}
    \item training hyperparameters
    \item training steps
    \item ablation tests
\end{itemize}

\begin{table}[H]
	\begin{minipage}{0.4\linewidth}
		\centering
		\caption{Classification report}\label{tab:imprpatches4phenotypes}
		\begin{tabular}{rcccc}
			\toprule
			{}                  & Precision & Recall & F1 score & Support \\
			\midrule
			sporulation         & 0.96      & 0.94   & 0.95     & 156     \\
			necrosis spots       & 0.86      & 0.82   & 0.84     & 90      \\
			necrosis flecks     & 0.82      & 0.90   & 0.86     & 41      \\
			necrosis senescence & 0.93      & 0.89   & 0.91     & 57      \\
			micro avg           & 0.91      & 0.90   & 0.90     & 344     \\
			macro avg           & 0.89      & 0.89   & 0.89     & 344     \\
			weighted avg        & 0.91      & 0.90   & 0.90     & 344     \\
			\bottomrule
		\end{tabular}
	\end{minipage}
\end{table}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{gc_hf_seg_sen_high.png}
	\caption*{Grad-CAM validation}\label{fig:gradcamval}
\end{figure}

\subsection{OIV 452-1 prediction}

\begin{itemize}
	\item Annotation of 1881 leaf discs with OIV 452-1
	\item Independent binary scales not enough to predict QTLs (will be tried t be sure)
	\item Use binary predictions + image data to create a scale to feed to the QTL research
	\item Multiple options for scale
	      \begin{itemize}
		      \item OIV 452-1
		      \item Create new scale \textbf{Possible approach: Use dimensional reduction techniques to check if some types of leaves are clustered}
		      \item Discrete or continuous?
	      \end{itemize}
	\item Validate method by analyzing previous known experiments
	\item \textbf{Additional:} Compare human/computer annotations at different dai to see differencies in correlation by date
\end{itemize}

\textbf{Availabe:}
\begin{itemize}
	\item Annotations of 1881 leaf discs
\end{itemize}
\textbf{Missing:}
\begin{itemize}
	\item Annotation review
	\item Predictive model, discrete?
	\item Analyze previous experiments
\end{itemize}

\subsection{Experiments re-analysis}

\section{Results}

\subsection{Unreliable human factor \textbf{?}}

\subsection{Binary prediction as an heuristic for scale prediction}

\subsection{Result from experiment re-analysis}

\section{Discussion}

\section{Missing bibliography}

\begin{itemize}
    \item Velasquez-Camacho, L., Otero, M., Basile, B., Pijuan, J., Corrado, G. (2023). Current trends and perspectives on predictive models for mildew diseases in Vineyards. Microorganisms, 11, 73
    \item Merdinoglu et al., 2018, Hogbregat et al., 2019, (A trouver dans Possamai et wiedemann\_merdinoglu, 2022)
    \item Velasquez-Camacho et al., 2023
\end{itemize}




% \clearpage
\printbibliography

\end{document}

